<!doctype html>
<html lang="zh-hans">
  <head>
  <meta name="charset" content="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Nim程序设计语言是一种简洁、快速的编程语言， 可被编译成C、C++甚至JavaScript。">
  <meta charset="utf-8">
  <link rel="icon" type="image/png" href="/assets/img/logo_bw.png" />

  
  <title>Nim代码的文档化、分析和调试指南 - Nim博客</title>
  
  <link rel="stylesheet" href="/assets/css/pure.min.css">
  <link rel="stylesheet" href="/assets/css/pure-grids-responsive.min.css">
  <!-- <link href="https://use.fontawesome.com/releases/v5.0.2/css/all.css" rel="stylesheet"> -->
  <link href="https://cdn.bootcss.com/font-awesome/5.10.2/css/all.min.css" rel="stylesheet">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
  
  <link rel="stylesheet" href="/assets/css/highlight/github.css">
  

  <meta name="keyword" content="nim,nim中文,Nim中文社区,nim中文网,nim语言,nim编程语言">

  <!-- <link href="https://fonts.googleapis.com/css?family=Inconsolata|Open+Sans|Titillium+Web" rel="stylesheet"> -->
  <link href="https://fonts.font.im/css?family=Inconsolata|Open+Sans|Titillium+Web" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?t=1579283467950800367">

  <!-- <meta name="twitter:title" content="Nim代码的文档化、分析和调试指南"> -->

  
  <!-- <meta name="twitter:description" content="本指南讨论了一些用于注释和生成文档、分析和调试nim代码的实用工具。"> -->
  <meta property="og:description" content="本指南讨论了一些用于注释和生成文档、分析和调试nim代码的实用工具。">
  

  <!-- <meta name="twitter:site" content="@nim_lang"> -->
  <!-- <meta name="twitter:card" content="summary_large_image"> -->
  <!-- <meta name="twitter:image" content="https://nim-lang.org/assets/img/twitter_banner.png">  -->

  <meta property="og:title" content="Nim代码的文档化、分析和调试指南" />
  <meta property="og:site_name" content="Nim中文社区" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://nim-cn.com/assets/img/twitter_banner.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1000" />
  <meta property="og:image:height" content="500" />
  <meta property="og:image:alt" content="Nim中文" />

  <meta name="copyright" content="Nim中文社区">

  <!-- SEO START -->
  <!-- baidu -->
  <meta name="baidu-site-verification" content="D5uE3gaRue" />
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-144592616-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-144592616-1');
  </script>
  <!-- bing -->
  <meta name="msvalidate.01" content="664E5CE055C5DCC50BB1238208911CDF" />
  <!-- yandex -->
  <meta name="yandex-verification" content="24900ce4c46b3893" />
  <!-- SEO END -->

  <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
</head>

  <body class="site">
    <header>
  <nav class="pure-menu pure-menu-horizontal pure-menu-scrollable">
    <div class="nav-content">
      <a href="/" class="pure-menu-heading pure-menu-link site-logo-container">
        <img class="site-logo" src="/assets/img/logo.svg" height="28" alt="Nim">
      </a>
      <ul class="pure-menu-list">
        
        <li class="pure-menu-item">
          <a href="http://tea.nim-cn.com/"
             class="pure-menu-link ">
            每日早茶
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/blog.html"
             class="pure-menu-link ">
            博客
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/features.html"
             class="pure-menu-link ">
            特点
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/install.html"
             class="pure-menu-link ">
            下载
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/learn.html"
             class="pure-menu-link ">
            学习
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/documentation.html"
             class="pure-menu-link ">
            文档
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/community.html"
             class="pure-menu-link ">
            社区
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://github.com/nim-lang/Nim">源码</a>
        </li>
      </ul>
    </div>
    <div class="menu-fade"></div>
  </nav>
</header>

    <div class="site-content post-page">
      <div class="content">
        <div class="width-reduced">
          <h1 class="post-title">
            Nim代码的文档化、分析和调试指南
          </h1>
          <h3 class="post-meta">
            <span>
              <i class="far fa-calendar-alt" aria-hidden="true"></i>
              02 October 2017
            </span>
            
            <span>
              <i class="fa fa-user-circle" aria-hidden="true"></i>
              Dominik Picheta
            </span>
            
          </h3>
          <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#代码文档化">1. 代码文档化</a></li>
<li><a href="#分析代码">2. 分析代码</a>
<ul class="sectlevel2">
<li><a href="#使用-nimprof-进行性能分析">2.1. 使用 <strong>nimprof</strong> 进行性能分析</a></li>
<li><a href="#使用-valgrind-进行分析">2.2. 使用 <strong>Valgrind</strong> 进行分析</a></li>
</ul>
</li>
<li><a href="#debugging-nim-code">3. Debugging Nim code</a>
<ul class="sectlevel2">
<li><a href="#debugging-using-echo">3.1. Debugging using <code>echo</code></a></li>
<li><a href="#using-writestacktrace">3.2. Using <code>writeStackTrace</code></a></li>
<li><a href="#using-gdblldb">3.3. Using GDB/LLDB</a></li>
</ul>
</li>
<li><a href="#conclusion">4. Conclusion</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">Nim in Action</div>
<div class="paragraph">
<p>
<table class="hackytable">
  <tr>
  <td width="200px">
  <img src="https://nim-cn.com/assets/img/nim_in_action_cover.jpg"/>
  </td>
  <td style="padding-left: 10pt;">

这一小篇手册最初是为了
<a href="https://book.picheta.me">Nim in Action</a>写的。</p>
</div>
<div class="paragraph">
<p>由于篇幅限制，书中并没有收录。
<strong>Nim in Action</strong> 的编写方式和这个指南很类似，
你可以把这本书买来（或找来）看看，
以便更加深入地了解 <strong>Nim</strong> 语言。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Discount</div>
使用优惠码 <code>fccpicheta</code> 可以获得六四折优惠。

</td>
</tr>
</table>

</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>本手册将会和你一起探讨一些实用的工具，
用以文档化、分析和调试 <strong>Nim</strong> 代码。
我将会介绍如下内容:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>在 <strong>Nim</strong> 的文档注释中使用的 <strong>reStructuredText</strong> 语言（RST）</p>
</li>
<li>
<p><strong>Nim</strong> 性能和内存使用情况分析器</p>
</li>
<li>
<p>将 <strong>GDB/LLDB</strong> 与 <strong>Nim</strong> 一起使用</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>请务必准备好 <strong>nim</strong> 编译器，
并按照本指南中的说明进行操作，
以便达到最佳效果。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="代码文档化">1. 代码文档化</h2>
<div class="sectionbody">
<div class="paragraph">
<p>给代码写注释和文档非常重要！
尤其是在直接查看库的 <strong>api</strong> 甚至软件的源码时。
它能够解释软件中一些可能不是很明显细节，</p>
</div>
<div class="paragraph">
<p>有很多种方式来达到这个效果。
比如你可能已经知道了，
<strong>Nim</strong> 像很多语言那样支持注释。
注释是源码的说明解释，
让代码能更容易地被理解。</p>
</div>
<div class="paragraph">
<p>在nim中，单行注释由井号 <code>&#35;</code> 分隔。
多行注释由 <code>&#35;[</code> and <code>]&#35;</code> 包裹起来。
在<a href="#list_1_1">代码 1.1</a> 中，分别进行了这两者的示例。</p>
</div>
<div id="list_1_1" class="listingblock">
<div class="title">代码 1. 1. <strong>Nim</strong> 中的注释</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="nim"><span></span><span style="color: #008000; font-weight: bold">var</span> x <span style="color: #666666">=</span> <span style="color: #666666">5</span> <span style="color: #408080; font-style: italic"># Assign 5 to x.</span>
<span style="color: #408080; font-style: italic">#[multi-</span>
  line      <i class="conum" data-value="1"></i><b>(1)</b>
  comment<span style="color: #666666">]</span><span style="color: #408080; font-style: italic">#</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>这种语法还算是挺新的，所以一般都不会支持 <strong>Nim</strong> 的语法高亮。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Nim</strong> 也提供了一种叫做 <strong>"文档注释"</strong> 的特殊注释类型。
这种类型的注释由nim的文档生成器处理。
只要用两个井号 <code>&#35;&#35;</code> 写的注释都是文档注释。</p>
</div>
<div id="list_1_2" class="listingblock">
<div class="title">代码 1. 2. 一个简单的文档注释的例子</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="nim"><span></span><span style="color: #BA2121; font-style: italic">## 这是``test`` 模块的 *文档注释* .</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#list_1_2">代码 1.2</a> 展示了一个非常简单的文档注释
<strong>Nim</strong> 编译器包含了一个能给指定模块生成文档的命令。
实际代码在 <a href="#list_1_2">代码 1.2</a> 中，
比如说你电脑里有个 <code>test.nim</code> ，然后你可以执行 <code>nim doc test.nim</code>。
一般会在你的 <code>test.nim</code> 文件旁边生成一个 <code>test.html</code>。
在你最爱的那个浏览器中打开它，就能看到生成出来的 <strong>HTML</strong>
就像 <a href="#fig_1_1">图 1.1</a> 中的截图这样：</p>
</div>
<div id="fig_1_1" class="imageblock">
<div class="content">
<img src="/assets/news/images/asciidoc/ch05_docgen.png" alt="ch05 docgen">
</div>
<div class="title">图 1. 1. 给 <code>test.nim</code> 模块生成的文档</div>
</div>
<div class="paragraph">
<p>注意截图和你看到的文本样式可能会有差异，请以实际效果为准:)。
"documentation comment"这俩字是斜体的，
因为在文档注释中是用星号(<code>*</code>)包裹起来的。
而 "test" 是用两个反引号包起来的，
这样能显得字体是等距的，
在讨论诸如变量名之类的标识符时很有用。</p>
</div>
<div class="paragraph">
<p>这些特殊的符号是文档生成器支持的 <strong>reStructuredText</strong> 标记语言的一小部分玩法。
文档生成器先解读你在命令行中指定的文件，
然后找到并逐一检查其中的所有文档注释。
每个文档注释都被 <strong>reStructuredText</strong> 解析器所解析。
然后文档生成器基于他解析的 <strong>reStructuredText</strong> 标记生成 <strong>HTML</strong>。</p>
</div>
<div class="paragraph">
<p><a href="#table_1_1">表 1.1</a>列出了 <strong>reStructuredText</strong> 的一些语法。</p>
</div>
<table id="table_1_1" class="tableblock frame-all grid-all stretch">
<caption class="title">表 1. 1. <strong>reStructuredText</strong> 语法示例</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">语法</th>
<th class="tableblock halign-left valign-top">效果</th>
<th class="tableblock halign-left valign-top">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>*斜体*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>斜体</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">不明显地强调</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>**粗体**</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>粗体</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">明显强调</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>``等宽字体``</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>monospace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">用于标识出 变量、过程 之类的名字.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>`超链接 &lt;http://baidu.com&gt;`_</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://baidu.com">超链接</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">链接到其他网页</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>
标题<br>
=======<br>
</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><span class="image"><img src="/assets/news/images/asciidoc/ch05_rst_heading.png" alt="ch05 rst heading" width="120"></span></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>=</code> 可以是任何标点符号，标题级由标题的继承确定（译者：也就是上下文啦）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.. code-block:: nim</code><br></p>
<p class="tableblock"><pre>
  echo("Hello World")
</pre>
</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>
echo("Hello World")
</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">用来展示示例代码。这将为指定的代码添加语法突出显示。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>更全面的参考，请查看以下链接：
<a href="http://sphinx-doc.org/rest.html" class="bare">http://sphinx-doc.org/rest.html</a></p>
</div>
<div class="paragraph">
<p>接下来我们再看个例子。</p>
</div>
<div id="list_1_3" class="listingblock">
<div class="title">代码 1. 3. 不同位置的文档注释</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="nim"><span></span><span style="color: #BA2121; font-style: italic">## 这是世界上最好的模块！</span>
<span style="color: #BA2121; font-style: italic">## 我们有一大堆文档！</span>
<span style="color: #BA2121; font-style: italic">##</span>
<span style="color: #BA2121; font-style: italic">##</span>
<span style="color: #BA2121; font-style: italic">## 示例</span>
<span style="color: #BA2121; font-style: italic">## ========</span>
<span style="color: #BA2121; font-style: italic">##</span>
<span style="color: #BA2121; font-style: italic">## 下面给你看几个例子：</span>
<span style="color: #BA2121; font-style: italic">##</span>
<span style="color: #BA2121; font-style: italic">##</span>
<span style="color: #BA2121; font-style: italic">## 把俩数加起来</span>
<span style="color: #BA2121; font-style: italic">## ---------------------------</span>
<span style="color: #BA2121; font-style: italic">##</span>
<span style="color: #BA2121; font-style: italic">## .. code-block:: nim</span>
<span style="color: #BA2121; font-style: italic">##</span>
<span style="color: #BA2121; font-style: italic">##   doAssert add(5, 5) == 10</span>
<span style="color: #BA2121; font-style: italic">##</span>

<span style="color: #008000; font-weight: bold">proc </span><span style="color: #0000FF">add</span><span style="color: #666666">*</span>(a, b: <span style="color: #B00040">int</span>): <span style="color: #B00040">int</span> <span style="color: #666666">=</span>
  <span style="color: #BA2121; font-style: italic">## integer 类型的 ``a`` 加上 integer 类型的 ``b`` 然后返回运算结果。</span>
  <span style="color: #008000; font-weight: bold">return</span> a <span style="color: #666666">+</span> b</code></pre>
</div>
</div>
<div id="fig_1_2" class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#list_1_3">代码 1.3</a> 生成的文档
image::ch05_math_docs.png[]</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>从 <a href="#list_1_3">代码 1.3</a> 中的示例可以看出,
文档注释可以放在很多地方。</p>
</div>
<div class="paragraph">
<p>它们可以在全局作用域内，也可以在过程的局部作用域内。
在过程文档下的文档注释中，说明该过程的用途，
<strong>Nim</strong> 文档生成器Nim文档生成器会生成模块中导出的所有过程的列表，
写了文档注释的的文档将会被显示在下面，
就像 <a href="#fig_1_2">图 1.2</a>中那样。</p>
</div>
<div class="paragraph">
<p>这就是Nim标准库中使用注释和生成文档的方式。
有关如何使用注释和生成文档的更多实例，请查看
<a href="https://github.com/nim-lang/Nim/tree/devel/lib/pure">它的源码</a>].</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="分析代码">2. 分析代码</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>分析</strong> 应用，是指在应用运行时对其进行分析，以确定其所花费的时间。
像：它在哪个过程中花费时间最多啦、或者每个过程被调用了多少次之类的。
这些数值可以帮助你找到需要优化的代码区域。
有时它们还可以帮助您在应用程序中发现错误。</p>
</div>
<div class="paragraph">
<p><strong>Nim</strong> 语言其实有很多很多能用的分析器。
挺惊人吧？毕竟 <strong>Nim</strong> 还是一门挺新的语言。
其实吧，这里的大多数分析器并不是专门给 <strong>Nim</strong> 创建的，而是给 <strong>C</strong> 。
<strong>C</strong> 分析器支持 <strong>Nim</strong> 应用，因为 <strong>Nim</strong> 可以编译为 <strong>C</strong> 。
要想用好这些分析器，你只需要了解这几件事。</p>
</div>
<div class="paragraph">
<p>事实上 <strong>Nim</strong> 编译器包含了一个探查器，
它是目前来说唯一一个用于对 <strong>Nim</strong> 应用程序进行性能分析的分析器。
在转到 <strong>C</strong> 分析器之前，让我们看一下它。</p>
</div>
<div class="sect2">
<h3 id="使用-nimprof-进行性能分析">2.1. 使用 <strong>nimprof</strong> 进行性能分析</h3>
<div class="paragraph">
<p>嵌入式堆栈跟踪分析器（<strong>ESTP</strong>）（有时也称为 <strong>NimProf</strong>）是标准 <strong>Nim</strong> 发行版中附带的 <strong>Nim</strong> 分析器。
要激活这个分析器，您只需执行以下步骤：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在你的程序的 <strong>Nim</strong> 主模块（将要编译的模块）中导入 <code>nimprof</code> 模块，</p>
</li>
<li>
<p>使用 <code>--profiler:on</code> 和 <code>stacktrace:on</code> 标志编译程序。</p>
</li>
<li>
<p>正常运行它。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">应用速度</div>
分析你的应用程序时，运行速度会变慢，
      这是因为分析器需要在运行时分析应用程序的执行情况，
      这会带来明显的开销。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>看一眼下面的代码。</p>
</div>
<div id="listing_1_4" class="listingblock">
<div class="title">代码 1. 4. 简单的分析器示例</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="nim"><span></span><span style="color: #008000; font-weight: bold">import</span> nimprof <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #008000; font-weight: bold">import</span> strutils <i class="conum" data-value="2"></i><b>(2)</b>

<span style="color: #008000; font-weight: bold">proc </span><span style="color: #0000FF">ab</span>() <span style="color: #666666">=</span>
  echo(<span style="color: #BA2121">&quot;Found letter&quot;</span>)

<span style="color: #008000; font-weight: bold">proc </span><span style="color: #0000FF">num</span>() <span style="color: #666666">=</span>
  echo(<span style="color: #BA2121">&quot;Found number&quot;</span>)

<span style="color: #008000; font-weight: bold">proc </span><span style="color: #0000FF">diff</span>() <span style="color: #666666">=</span>
  echo(<span style="color: #BA2121">&quot;Found something else&quot;</span>)

<span style="color: #008000; font-weight: bold">proc </span><span style="color: #0000FF">analyse</span>(x: <span style="color: #B00040">string</span>) <span style="color: #666666">=</span>
  <span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">0</span>
  <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">true</span>:
    <span style="color: #008000; font-weight: bold">case</span> x<span style="color: #666666">[</span>i<span style="color: #666666">]</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color: #008000; font-weight: bold">of</span> Letters: ab()
    <span style="color: #008000; font-weight: bold">of</span> {<span style="color: #BA2121">&#39;0&#39;</span> .. <span style="color: #BA2121">&#39;9&#39;</span>}: num()
    <span style="color: #008000; font-weight: bold">of</span> <span style="color: #BA2121">&#39;</span><span style="color: #BB6622; font-weight: bold">\0</span><span style="color: #BA2121">&#39;</span>: <span style="color: #008000; font-weight: bold">break</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span style="color: #008000; font-weight: bold">else</span>: diff()
    i.inc

<span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0</span> .. <span style="color: #666666">10000</span>: <i class="conum" data-value="5"></i><b>(5)</b>
  analyse(<span style="color: #BA2121">&quot;uyguhijkmnbdv44354gasuygiuiolknchyqudsayd12635uha&quot;</span>)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>有了 <code>nimprof</code> 模块，探查器才能正常工作，所以该模块至关重要。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>strutils</code> 模块定义了 <code>Letters</code> 集合.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>字符串 <code>x</code> 中的每个字符都被遍历，如果这个字符是字母，那么调用 <code>ab</code> ；
如果是数字，就调用 <code>num</code> ；
其他情况调用 <code>diff</code> 。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>\0</code> 表示到了字符串的结尾，我们在这停止循环。</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>为了使 <strong>Profiler</strong> 的结果更加可靠，我们进行了1万次分析。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>将其另存为 <code>main.nim</code> ，
然后通过执行 <code>nim c --profiler:on --stacktrace:on main.nim</code> 来编译。
这个例子应该能成功编译。 然后，你可以运行它。
程序执行完毕后，您应该在终端窗口中看到一条类似于"writing profile_results.txt&#8230;&#8203;"的消息。
<code>main</code> 程序会在你当前的工作目录中创建一个 <code>profile_results.txt</code> 文件，
文件的内容看起来应该和
<a href="#listing_1_5">代码 1.5</a>差不多</p>
</div>
<div id="listing_1_5" class="listingblock">
<div class="title">代码 1. 5. 分析结果</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code><span></span>total executions of each stack trace:
Entry: 1/4 Calls: 89/195 = 45.64% [sum: 89; 89/195 = 45.64%]
  analyse 192/195 = 98.46%
  main 195/195 = 100.00%
Entry: 2/4 Calls: 83/195 = 42.56% [sum: 172; 172/195 = 88.21%]
  ab 83/195 = 42.56%
  analyse 192/195 = 98.46%
  main 195/195 = 100.00%
Entry: 3/4 Calls: 20/195 = 10.26% [sum: 192; 192/195 = 98.46%]
  num 20/195 = 10.26%
  analyse 192/195 = 98.46%
  main 195/195 = 100.00%
Entry: 4/4 Calls: 3/195 = 1.54% [sum: 195; 195/195 = 100.00%]
  main 195/195 = 100.00%</code></pre>
</div>
</div>
<div class="paragraph">
<p>在应用程序运行时，分析器会为当前正在执行的代码行拍摄多个快照。
它记录了应用程序最终如何执行那段代码堆栈跟踪。
然后记录在最常见的路径 <code>profile_results.txt</code> 中。</p>
</div>
<div class="paragraph">
<p>在 <a href="#listing_1_5">代码 1.5</a> 所示的报告中,
分析器制作了195个快照。
它发现正在执行的过程 <code>analyse</code> 中的代码行在那些快照中占了45.64%。
42.56%的快照调用了 <code>ab</code> 过程，没毛病，因为传递给 <code>analyse</code> 的字符串主要由字母组成。
数字没那么多，所以 <code>num</code> 过程的执行仅占了这些快照的10.26%。
分析器没有监测到 <code>diff</code> 过程的调用，因为在字符串 <code>x</code> 中没有其他字符。
试着在传递给 <code>analyse</code> 过程的字符串中添加一些标点符号，
你会发现分析器监测到并显示出来了 <code>diff</code> 过程。</p>
</div>
<div class="paragraph">
<p>在不使用分析器的情况下，很容易确定 <a href="#listing_1_4">代码 1.4</a> 中大部分程序处理了的位置。
但是对于更复杂的模块和应用，<strong>Nim Profiler</strong> 非常适合确定哪些程序最常用。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">内存使用情况</div>
<strong>Nim</strong> 分析器也可用于测量内存使用情况，
    只需要使用`--profiler:off`、<code>--stackTrace:on</code>、和 <code>-d:memProfiler</code> 标志编译你的应用即可。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="使用-valgrind-进行分析">2.2. 使用 <strong>Valgrind</strong> 进行分析</h3>
<div class="paragraph">
<p>不幸的是，分析器不都是跨平台的。
 <strong>Valgrind</strong> 就是一个例子，
 因为它并不支持 <strong>Windows</strong> 。</p>
</div>
<div class="paragraph">
<p><strong>Valgrind</strong> 不只是一个分析器，
它是一个主要用来调试内存和检测内存泄漏的工具。
分析器组件叫做 <strong>Callgrind</strong>，它分析你的应用调用了哪些过程，以及这些过程之后的调用，依此类推。</p>
</div>
<div class="paragraph">
<p>叫做 <strong>KCacheGrind</strong> 的应用可以把 <strong>Callgrind</strong> 的结果可视化地输出出来。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">安装 Valgrind</div>
要使用此处的示例，您将需要将 <strong>Valgrind</strong> 工具与 <strong>KCacheGrind</strong> 一起安装。
      如果您使用的是 <strong>Linux</strong>，很有可能操作系统上已经安装了这些工具。
      在 <strong>Mac OS X</strong> 上，你可以简单地通过执行下面的代码来安装
      <code>brew install valgrind QCacheGrind</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>让我们在 <a href="#listing_1_4">listing 1.4</a> 中列出的应用中试一下 <strong>Valgrind</strong> 吧。
首先通过运行来重新编译没有任何标志的应用程序 <code>nim c main</code>。
你需要注释掉 <code>main.nim</code> 文件中的 <code>import nimprof</code> 这一行，才能成功完成此操作。</p>
</div>
<div class="paragraph">
<p>然后，执行以下命令，在 <strong>Valgrind</strong> 下运行刚才的应用： <code>valgrind --tool=callgrind -v ./main</code></p>
</div>
<div class="paragraph">
<p><strong>callgrind</strong> 工具比 <strong>Nim</strong> 分析器增加了更大的开销，
因此您可能需要终止应用程序，
可以通过同时按 <code>Control</code> 和 <code>C</code> 键来安全地终止应用程序。</p>
</div>
<div class="paragraph">
<p>callgrind工具提供的文本输出非常大，
因此想直接在文本编辑器中查看所有内容是不切实际的。</p>
</div>
<div class="paragraph">
<p>Thankfully a tool exists to allow us to explore it visually.
This tool is called KCacheGrind (QCacheGrind on Mac OS X).
You can execute it in the directory where you executed Valgrind to get something similar to the screenshot in
<a href="#figure_1_3">figure 1.3</a>.</p>
</div>
<div id="figure_1_3" class="imageblock">
<div class="content">
<img src="/assets/news/images/asciidoc/ch05_qcachegrind.png" alt="ch05 qcachegrind">
</div>
<div class="title">图 1. 2. QCacheGrind showing the call graph of <a href="#listing_1_4">listing 1.4</a></div>
</div>
<div class="paragraph">
<p>The results of the Callgrind tool show many more calls during the lifetime of
<a href="#listing_1_4">listing 1.4</a>. This is because many of the C
functions, which have been defined by Nim, during the translation to C
are now visible. These functions are necessary to implement the behaviour of
the code in <a href="#listing_1_4">listing 1.4</a>.</p>
</div>
<div class="paragraph">
<p>The C function which is selected in the screenshots corresponds to the
<code>analyse</code> Nim procedure. Procedures' names undergo a process called name
mangling when translated to C functions, this prevents clashes between other
C functions. The name mangling process currently just adds an underscore
followed by a number to the C function name. Thankfully figuring out which
C functions correspond to which Nim procedures is still easy.</p>
</div>
<div class="paragraph">
<p>The output from Callgrind gives you more low-level details about the
execution of your Nim applications. <a href="#figure_1_3">图 1.3</a> shows the
number of times
every single C function has been executed, it allows you to diagnose performance
problems which may be outside your control. But with greater power comes
greater complexity so Valgrind has a higher learning curve than the Nim
profiler.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="debugging-nim-code">3. Debugging Nim code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Debugging is one of the most important activities in software development.
Bugs in software occur inadvertantly. When a user reports an issue with
your software, how do you fix it?</p>
</div>
<div class="paragraph">
<p>The first step is to reproduce the issue. After that debugging tools help to
diagnose the issue and to figure out its root cause.</p>
</div>
<div class="paragraph">
<p>Nim does many things to make debugging as easy as possible. For example it
ensures that detailed and easy to understand stack traces are reported
whenever your application crashes. Consider the following code in
<a href="#listing_1_6">listing 1.6</a>.</p>
</div>
<div id="listing_1_6" class="listingblock">
<div class="title">代码 1. 6. A simple calculator</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="nim"><span></span><span style="color: #008000; font-weight: bold">import</span> strutils <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #008000; font-weight: bold">let</span> line <span style="color: #666666">=</span> stdin.readLine() <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #008000; font-weight: bold">let</span> result <span style="color: #666666">=</span> line.parseInt <span style="color: #666666">+</span> <span style="color: #666666">5</span> <i class="conum" data-value="3"></i><b>(3)</b>
echo(line, <span style="color: #BA2121">&quot; + 5 = &quot;</span>, result) <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>strutils</code> module defines the <code>parseInt</code> procedure.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Read a line from the standard input.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The string <code>line</code> is converted into an integer, the number 5 is then
added to that integer.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Display the result of the calculation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This code is fairly simple. It reads a line of text from the standard input,
converts this line into an integer, adds the number 5 to it and displays
the result. Save this code as <code>adder.nim</code> and compile it by executing
<code>nim c adder.nim</code>, then execute the resulting binary. The program will
wait for your input, once you type in a number you will see the sum of 5
and the number you typed in. But what happens when you don&#8217;t type in a number?
Type in some text and observe the results. You should see something similar
to the output in <a href="#listing_1_7">listing 1.7</a> below.</p>
</div>
<div id="listing_1_7" class="listingblock">
<div class="title">代码 1. 7. Stack trace for a <code>ValueError</code> exception</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code><span></span>Traceback (most recent call last)
adder.nim(3)             adder <i class="conum" data-value="1"></i><b>(1)</b>
strutils.nim             parseInt <i class="conum" data-value="2"></i><b>(2)</b>
Error: unhandled exception: invalid integer: some text [ValueError] <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The program was executing line 3 in the <code>adder</code> module&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>&#8230;&#8203; followed by the <code>parseInt</code> procedure which raised the <code>ValueError</code>
exception.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is the exception message followed by the exception type in
square brackets.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The program crashed because an exception was raised and it was not caught
by any <code>try</code> statements. This resulted in a stack trace being displayed and
the program exiting. The stack trace in <a href="#listing_1_7">listing 1.7</a> is
very informative,
it leads directly to the line which caused the crash. After the <code>adder.nim</code>
module name, the number <code>3</code> points to the line number
in the <code>adder</code> module. This line is highlighted in
<a href="#listing_1_8">listing 1.8</a> below.</p>
</div>
<div id="listing_1_8" class="listingblock">
<div class="title">代码 1. 8. A simple calculator</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="nim"><span></span><span style="color: #008000; font-weight: bold">import</span> strutils
<span style="color: #008000; font-weight: bold">let</span> line <span style="color: #666666">=</span> stdin.readLine()
<span style="color: #666666"><strong></span><span style="color: #008000; font-weight: bold">let</span> result <span style="color: #666666">=</span> line.parseInt <span style="color: #666666">+</span> <span style="color: #666666">5</strong></span>
echo(line, <span style="color: #BA2121">&quot; + 5 = &quot;</span>, result)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>parseInt</code> procedure cannot convert strings containing only letters
into a number because no number exists in that string. The exception message
shown at the bottom of the stack trace informs us of this. It includes
the string value that <code>parseInt</code> attempted to parse which gives further hints
about what went wrong.</p>
</div>
<div class="paragraph">
<p>You may not think it but program crashes are a good thing when it comes
to debugging. The truly horrible bugs are the ones which produce no crashes,
but instead result in your program producing incorrect results. In such cases
advanced debugging techniques need to be used. Debugging also comes in handy
when a stack trace does not give enough information about the issue.</p>
</div>
<div class="paragraph">
<p>The primary purpose of debugging is to investigate the state of memory
at a particular point in the execution of your program. You may for example
want to find out what the value of the <code>line</code> variable is just before
the <code>parseInt</code> procedure is called. This can be done in many ways.</p>
</div>
<div class="sect2">
<h3 id="debugging-using-echo">3.1. Debugging using <code>echo</code></h3>
<div class="paragraph">
<p>By far the simplest and most common approach is to use the <code>echo</code>
procedure. The <code>echo</code>
procedure allows you to display the value of most variables, as long as the
type of the variable implements the <code>$</code> procedure it can be displayed.
For other variables the <code>repr</code> procedure can be used, you can pass any
type of variable to it and get a textual representation of that
variable&#8217;s value.</p>
</div>
<div class="paragraph">
<p>Using the <code>repr</code> procedure and <code>echo</code>, let&#8217;s investigate the value of the
<code>line</code> variable just before the call to <code>parseInt</code>.</p>
</div>
<div id="listing_1_9" class="listingblock">
<div class="title">代码 1. 9. Investigating the value of the <code>line</code> variable using <code>repr</code>.</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="nim"><span></span><span style="color: #008000; font-weight: bold">import</span> strutils
<span style="color: #008000; font-weight: bold">let</span> line <span style="color: #666666">=</span> stdin.readLine()
<span style="color: #666666"><strong></span>echo(<span style="color: #BA2121">&quot;The value of the <code>line</code> variable is: &quot;</span>, repr(line))<span style="color: #666666"></strong></span>
<span style="color: #008000; font-weight: bold">let</span> result <span style="color: #666666">=</span> line.parseInt <span style="color: #666666">+</span> <span style="color: #666666">5</span>
echo(line, <span style="color: #BA2121">&quot; + 5 = &quot;</span>, result)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>repr</code> procedure is useful because it shows non-printable characters
in their escaped form. It also shows extra information about many types of
data. Running the example in <a href="#listing_1_9">listing 1.9</a> and typing in 3 Tab
characters results in the following output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code><span></span>The value of the `line` variable is: 0x105ff3050&quot;\9\9\9&quot;
Traceback (most recent call last)
foo.nim(4)               foo
strutils.nim             parseInt
Error: unhandled exception: invalid integer:       [ValueError]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The exception message just shows some whitespace which is how Tab characters
are shown in normal text. But you have no way of distinguishing whether
that whitespace is just normal space characters or whether it is in fact a
multiple Tab characters. The <code>repr</code> procedure solves this ambiguity by showing
<code>\9\9\9</code>, the number 9 is the ASCII number code for the tab character.
The memory address of the <code>line</code> variable is also shown.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Procedures with no side effects and <code>echo</code></div>
<div class="paragraph">
<p>A procedure marked with the <code>{.noSideEffect.}</code> pragma is said to have no side
effect. This means that the procedure does not modify or read any
external state, such
as changing global variables or writing to a file. Marking a procedure as
having no side effects is useful when you want this to be enforced by the
compiler, that way the code will not compile unless the procedure
remains side effect free. For example consider the following <code>add</code> procedure,
it is said to contain no side effects because passing the same inputs to this
procedure will always produce the same output.</p>
</div>
<div class="listingblock">
<div class="title">代码 1. 10. The side effect free <code>add</code> procedure</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="nim"><span></span><span style="color: #008000; font-weight: bold">proc </span><span style="color: #0000FF">add</span>(a, b: <span style="color: #B00040">int</span>): <span style="color: #B00040">int</span> {.noSideEffect.} <span style="color: #666666">=</span>
  <span style="color: #008000; font-weight: bold">return</span> a <span style="color: #666666">+</span> b</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a problem whenever you want to debug such procedures with the
<code>echo</code> procedure. The <code>echo</code> procedure is not side effect free because it
accesses a global <code>stdout</code> variable. So the following code will not compile.</p>
</div>
<div id="listing_1_11" class="listingblock">
<div class="title">代码 1. 11. <code>echo</code> cannot be used inside a side effect free procedure</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="nim"><span></span><span style="color: #008000; font-weight: bold">proc </span><span style="color: #0000FF">add</span>(a, b: <span style="color: #B00040">int</span>): <span style="color: #B00040">int</span> {.noSideEffect.} <span style="color: #666666">=</span>
  echo(<span style="color: #BA2121">&quot;Value of a is:&quot;</span>, a)
  <span style="color: #008000; font-weight: bold">return</span> a <span style="color: #666666">+</span> b</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compiling the code in <a href="#listing_1_11">listing 1.11</a> will fail with an error:
"'add' can have side effects". Thankfully the solution is simple. Nim provides
a side effect free <code>echo</code> for this very purpose, it is called <code>debugEcho</code> so
all you need to do is replace <code>echo</code> with <code>debugEcho</code> and the code will
compile.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-writestacktrace">3.2. Using <code>writeStackTrace</code></h3>
<div class="paragraph">
<p>An unhandled exception is not the only way for a stack trace to be displayed.
You may find it useful to display the current stack trace anywhere in your
program for debugging purposes. This can give you vital information, especially
in larger programs with many procedures, where it can show you the
path through those procedures and how your program&#8217;s execution ended in a
certain procedure.</p>
</div>
<div class="paragraph">
<p>Consider the following example.</p>
</div>
<div class="listingblock">
<div class="title">代码 1. 12. <code>writeStackTrace</code> example</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="nim"><span></span><span style="color: #008000; font-weight: bold">proc </span><span style="color: #0000FF">a1</span>() <span style="color: #666666">=</span>
  writeStackTrace()

<span style="color: #008000; font-weight: bold">proc </span><span style="color: #0000FF">a</span>() <span style="color: #666666">=</span>
  a1()

a()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compiling and running this example will display the following stack trace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code><span></span>Traceback (most recent call last)
foo.nim(7)               foo
foo.nim(5)               a
foo.nim(2)               a1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>a</code> procedure is called first on line 7, followed by <code>a1</code> at line 5,
and finally the <code>writeStackTrace</code> procedure is called on line 2.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-gdblldb">3.3. Using GDB/LLDB</h3>
<div class="paragraph">
<p>Sometimes a proper debugging tool is necessary for the truly complicated
issues. As with profiling tools in the previous section, Nim programs can be
debugged using most C debuggers. One of the most popular debugging tools
is the GNU Debugger, its often known by the acronym GDB.</p>
</div>
<div class="paragraph">
<p>The GNU debugger should be included with your distribution of gcc which you
should already have as part of your Nim installation. Unfortunately on the
latest versions of
Mac OS X installation of gdb is problematic, but you can use a similar debugger
called LLDB. LLDB is a much newer debugger, but it functions in almost
exactly the same way.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try to use GDB (or LLDB if you&#8217;re on Mac OS X) to debug the small
<code>adder.nim</code> example introduced in <a href="#listing_1_8">listing 1.8</a>.
I will repeat the example below.</p>
</div>
<div class="listingblock">
<div class="title">代码 1. 13. The <code>adder.nim</code> example</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="nim"><span></span><span style="color: #008000; font-weight: bold">import</span> strutils
<span style="color: #008000; font-weight: bold">let</span> line <span style="color: #666666">=</span> stdin.readLine()
<span style="color: #008000; font-weight: bold">let</span> result <span style="color: #666666">=</span> line.parseInt <span style="color: #666666">+</span> <span style="color: #666666">5</span>
echo(line, <span style="color: #BA2121">&quot; + 5 = &quot;</span>, result)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to use these debugging tools you will need to compile <code>adder.nim</code>
with two additional flags. The <code>--debuginfo</code> flag, which will instruct the
compiler to add extra debugging information to the resulting binary. The
debugging information will be used by GDB and LLDB to read procedure names
and line numbers of the currently executed code.
And also the <code>--linedir:on</code> flag which will include Nim-specific debug
information
such as module names and Nim source code lines. GDB and LLDB will use the
information added by the <code>--linedir:on</code> flag to report Nim-specific module
names and line numbers.</p>
</div>
<div class="paragraph">
<p>Putting both of these together you should compile the <code>adder</code> module using the
following command: <code>nim c --debuginfo --linedir:on adder.nim</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">The <code>--debugger:native</code> flag</div>
Newer versions of Nim support the <code>--debugger:native</code> flag which is
     equivalent to specifying the <code>--linedir:on</code> and <code>--debuginfo</code> flags.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next step is to launch the debugging tool. The usage of both of these tools
is very similar. To launch the <code>adder</code> executable in GDB execute <code>gdb adder</code>
and to launch it in LLDB execute <code>lldb adder</code>. GDB or LLDB should launch
and you should see something similar to <a href="#figure_1_4">figure 1.4</a>
or <a href="#figure_1_5">figure 1.5</a>.</p>
</div>
<div id="figure_1_4" class="imageblock">
<div class="content">
<img src="/assets/news/images/asciidoc/ch05_gdb_adder.PNG" alt="ch05 gdb adder">
</div>
<div class="title">图 1. 3. GDB on Windows</div>
</div>
<div id="figure_1_5" class="imageblock">
<div class="content">
<img src="/assets/news/images/asciidoc/ch05_lldb_adder.png" alt="ch05 lldb adder">
</div>
<div class="title">图 1. 4. LLDB on Mac OS X</div>
</div>
<div class="paragraph">
<p>Once these tools are launched they will wait for input from the user.
The input is in the form of a command. Both of these tools support a range
of different commands for controlling the execution of the program, to watch
the values of specific variables, to set breakpoints and much more. To get a
full list of supported commands type in <code>help</code> and press enter.</p>
</div>
<div class="paragraph">
<p>The aim for this debugging session is to find out the value of the <code>line</code>
variable, just like in the
previous sections. To do this we need to set a breakpoint at line 3 in the
<code>adder.nim</code> file. Thankfully, both GDB and LLDB share the same command syntax
for creating
breakpoints. Simply type in <code>b adder.nim:3</code> into the terminal and press enter.
A breakpoint should be successfully created, the debugger will confirm this
by displaying a message that is similar to <em>代码 5.23</em>.</p>
</div>
<div class="listingblock">
<div class="title">代码 1. 14. This message is shown when a breakpoint is successfully created in LLDB.</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code><span></span>Breakpoint 1: where = adder`adderInit000 + 119 at adder.nim:3, address = 0x0000000100020f17</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the breakpoint is created, you can instruct the debugger to run the
<code>adder</code> program by using the <code>run</code> command. Type in <code>run</code> into the terminal
and press enter. The program won&#8217;t hit the breakpoint because it will first
read a line from standard input, so after you use the <code>run</code> command you will
need to type something else into the terminal. This time the <code>adder</code> program
will read it.</p>
</div>
<div class="paragraph">
<p>The debugger will then stop the execution of the program at line 3.
Figures <a href="#figure_1_6">1.6</a> and <a href="#figure_1_7">1.7</a> show what that will look like.</p>
</div>
<div id="figure_1_6" class="imageblock">
<div class="content">
<img src="/assets/news/images/asciidoc/ch05_gdb_adder_2.PNG" alt="ch05 gdb adder 2">
</div>
<div class="title">图 1. 5. Execution paused at line 3 in GDB</div>
</div>
<div id="figure_1_7" class="imageblock">
<div class="content">
<img src="/assets/news/images/asciidoc/ch05_lldb_adder_2.png" alt="ch05 lldb adder 2">
</div>
<div class="title">图 1. 6. Execution paused at line 3 in LLDB</div>
</div>
<div class="paragraph">
<p>At this point in the execution of the program, we should be able to display the
value of the <code>line</code> variable.
Displaying the value of a variable is the same in
both GDB and LLDB.
One can use the <code>p</code> (or <code>print</code>) command to display the value of any variable.
Unfortunately you cannot simply type in <code>print line</code> and get the result.
This is because of name mangling which I mentioned in the profiling section.
Before you can print out the value of the <code>line</code> variable you will need to
find out what the new name of it is. In almost all cases the variable name will
only have an underscore followed by a randomised number appended to it.
This makes finding the name rather trivial, but the process differs between
GDB and LLDB.</p>
</div>
<div class="paragraph">
<p>In GDB it is simple
to find out the name of the <code>line</code> variable, you can simply type in
<code>print line_</code>
and press the Tab button. GDB will then auto-complete the name for you, or give
you a list of choices.</p>
</div>
<div class="paragraph">
<p>As for LLDB, because it does not support auto-complete via the Tab key, this
is a bit more complicated. You need to find the name of the variable by looking
at the list of local and global variables in the current scope. You can get
a list of local variables by using the <code>fr v -a</code>
(or <code>frame variable --no-args</code>) command, and a list of global variables
by using the <code>ta v</code> (or <code>target variable</code>) command. The <code>line</code> variable is
a global variable so type in <code>ta v</code> to get a list of the global variables.
You should see something similar to the screenshot in <a href="#figure_1_8">figure 1.8</a>.</p>
</div>
<div id="figure_1_8" class="imageblock">
<div class="content">
<img src="/assets/news/images/asciidoc/ch05_lldb_adder_3.png" alt="ch05 lldb adder 3">
</div>
<div class="title">图 1. 7. The list of global variables in LLDB</div>
</div>
<div class="paragraph">
<p>You can see the <code>line</code> variable at the bottom of the list as <code>line_106004</code>.</p>
</div>
<div class="paragraph">
<p>Now print the <code>line</code> variable by using the <code>print &lt;var_name_here&gt;</code> command,
make sure to replace the <code>&lt;var_name_here&gt;</code> with the name of the <code>line</code> variable
that you found from the previous step. Figures <a href="#figure_1_9">1.9</a> and
<a href="#figure_1_10">1.10</a> show what you may see.</p>
</div>
<div id="figure_1_9" class="imageblock">
<div class="content">
<img src="/assets/news/images/asciidoc/ch05_gdb_adder_3.PNG" alt="ch05 gdb adder 3">
</div>
<div class="title">图 1. 8. Printing the value of the <code>line</code> variable in GDB</div>
</div>
<div id="figure_1_10" class="imageblock">
<div class="content">
<img src="/assets/news/images/asciidoc/ch05_lldb_adder_4.png" alt="ch05 lldb adder 4">
</div>
<div class="title">图 1. 9. Printing the value of the <code>line</code> variable in LLDB</div>
</div>
<div class="paragraph">
<p>This unfortunately tells us nothing about the value of the <code>line</code> variable.
We are in the land of low-level C, so the <code>line</code> variable is a pointer to
a <code>NimStringDesc</code> type. We can dereference this pointer by appending an
asterisk to the beginning of the variable name: <code>print *line_106004</code>.</p>
</div>
<div class="paragraph">
<p>Doing this will show values of each of the fields in the <code>NimStringDesc</code>
type. Unfortunately in LLDB this does not show the value of the <code>data</code> field,
so we must explicitly access it: <code>print (char*)line_106004->data</code>. The
<code>(char*)</code> is required to cast the <code>data</code> field into something which LLDB
can display. Figures <a href="#figure_1_11">1.11</a> and <a href="#figure_1_12">1.12</a>
show what this looks like in GDB and LLDB respectively.</p>
</div>
<div id="figure_1_11" class="imageblock">
<div class="content">
<img src="/assets/news/images/asciidoc/ch05_gdb_adder_4.PNG" alt="ch05 gdb adder 4">
</div>
<div class="title">图 1. 10. Displaying the value of the <code>line</code> variable in GDB</div>
</div>
<div id="figure_1_12" class="imageblock">
<div class="content">
<img src="/assets/news/images/asciidoc/ch05_lldb_adder_5.png" alt="ch05 lldb adder 5">
</div>
<div class="title">图 1. 11. Displaying the value of the <code>line</code> variable in LLDB</div>
</div>
<div class="paragraph">
<p>This is much more complicated than simply using the <code>echo</code> procedure, but should
be useful for more complicated debugging scenarios. Hopefully this gave you
an idea of how to compile your Nim program so that it can
be debugged using GDB and LLDB. There are many more features that
these debuggers provide which are beyond the scope of this article. These
features allow you to analyse the execution of your program in many other
ways. You may wish
to learn more by looking at the many resources available online for these
debuggers and many others.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">4. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Thank you for reading. If you require help with these topics or anything else
related to Nim, be sure to get in touch with our
<a href="https://nim-lang.org/community.html">community</a>.</p>
</div>
</div>
</div>
        </div>
      </div>
    </div>
    <footer>
  <section class="content">
    <div class="pure-g">
      <div class="copyright pure-u-2-3">
        <p>
          除非另有说明，本页内容遵从
          <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0</a>
          许可。
          网站显示的代码遵从MIT许可。
        </p>
        <p>
          本网站在
          <a href="https://github.com/nim-lang-cn/website">GitHub</a>
          上可用并且欢迎提供贡献。
          官方网站由
          <a href="https://github.com/dom96">Dominik Picheta</a>和
          <a href="https://github.com/Calinou">Hugo Locurcio</a>设计。
          Logo由<a href="https://github.com/josephwecker">Joseph Wecker</a>设计。
        </p>
        <p>
          中文翻译由Nim中文社区提供。
          服务器和域名由<a href="https://blog.doylee.cn/">ch4o5</a>提供。
          <a href="https://github.com/gogolxdong">sheldon</a>提供了文档翻译和其他翻译支持。
        </p>
      </div>
      <div class="pure-u-1-3 right-center">
        <a href="https://www.hostwinds.com">
          <img src="https://www.hostwinds.com/hw-images/presskit/logo-white.png" />
        </a>
        <script data-cfbadgetype="a" data-cfbadgeskin="dkgray" type="text/javascript">
          //<![CDATA[
          try { window.CloudFlare || function () { var a = window.document, b = a.createElement("script"), a = a.getElementsByTagName("script")[0]; window.CloudFlare = []; b.type = "text/javascript"; b.async = !0; b.src = "//ajax.cloudflare.com/cdn-cgi/nexp/cloudflare.js"; a.parentNode.insertBefore(b, a) }(), CloudFlare.push(function (a) { a(["cloudflare/badge"]) }) } catch (e$$5) { try { console.error("CloudFlare badge code could not be loaded. " + e$$5.message) } catch (e$$6) { } };
          //]]>
        </script>
      </div>
    </div>
  </section>

</footer>
<script>
  (function () {
    function setTracking(a) {
      var url = a.href;
      a.onclick = function () {
        if (typeof (ga) !== "undefined") {
          ga('send', 'event', 'outbound', 'click', url, {
            'transport': 'beacon',
            'hitCallback': function () { document.location = url; }
          });
        }
      };
    }

    var a = document.getElementsByTagName("a");
    for (var i = 0; i < a.length; ++i) {
      if (a[i].hostname != location.hostname &&
        a[i].getAttribute("target") !== "_blank"
      ) {
        setTracking(a[i])
      }
    }
  })();
</script>
<script>
  $(function () {
    $("section a").attr("target", "_blank");
  });
</script>
<script>
  // 百度统计
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?c81f717a4630758267f3b86f9efa48f0";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
  
  </div>
  </body>
</html>
